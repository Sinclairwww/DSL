## DSL语言设计

1.  注释（Comment）：以 `#` 开始的行表示注释，用于提供代码的解释和说明。注释不会被解释执行，仅用于文档目的。
2.  步骤（Step）：以 `step` 关键字开始的部分表示一个执行步骤或阶段。每个步骤包含一系列指令，用于定义在该步骤中要执行的操作。例如，`step Main` 表示一个名为 "Main" 的步骤。
3.  指令（Instruction）：在每个步骤内部，可以包含多个指令，用于执行具体的操作。以下是一些常见的指令类型：
    -   `callpy`：调用一个 Python 函数，并传递参数。
    -   赋值语句：将值赋给一个变量，如 `$name = $_ret`。
    -   `speak`：用于输出文本。
    -   `wait`：等待一段时间。
    -   `switch` 和 `case`：用于条件分支和执行不同的操作，根据输入关键字或条件。
    -   `beep`：发出滴声。
    -   `hangup`：挂断电话连接。
4.  变量（Variable）：以 `$` 开头的名称表示变量，用于存储和传递值。例如，`$name` 和 `$balance` 是变量。
5.  参数（Argument）：在指令中可以传递参数，如 `$_number` 和 `$_input_keyword`。这些参数可以是输入数据、函数的返回值或其他信息。



## 应答机器人的模块设计

1.   ### ConfigLoader

     #### 主要功能: 

     加载配置文件，验证配置的完整性，处理缺省值，并提供方法来获取不同部分的配置信息

     #### 函数说明：

     1.  `__init__` 方法：初始化 `ConfigLoader` 类的实例。它可以接受一个可选的参数 `path`，如果提供了路径，它将尝试加载配置文件。在构造函数中，它还会调用 `load` 方法来加载配置文件。
     2.  `getConfig` 方法：返回配置文件解析出的对象。这个对象包含了从配置文件中读取的各种配置信息。
     3.  `load` 方法：加载配置文件，进行完整性检查，并处理缺省值。它接受两个可选参数：`path`（配置文件的路径，默认为"./config.yaml"）和 `encoding`（默认为"utf8"）。它使用 `yaml` 模块的 `load` 函数来解析配置文件，并通过 `_validate` 方法进行验证。如果验证通过，配置信息将存储在 `_config` 中，否则将创建一个空字典。
     4.  `getRuntimeConfig` 方法：返回配置中 "runtime" 部分的配置信息。
     5.  `getJobConfig` 方法：返回配置中 "job" 部分的配置信息。
     6.  `getScriptsConfig` 方法：返回配置中 "scripts" 部分的配置信息。
     7.  `_updateDefault` 方法：从默认配置文件中加载默认值，并将其与从配置文件加载的值合并。默认配置文件路径为 "./src/data/default_config.yaml"。这样做可以确保配置文件中未定义的配置项使用默认值。
     8.  `_validate` 方法：使用 `schema` 模块的 `Schema` 类定义了一个配置的模式。这个模式定义了配置中各个键的名称、类型和默认值。`_validate` 方法将配置文件与这个模式进行验证，以确保配置的完整性和正确性。

2.   ### Interpreter

     #### 主要功能：

     将脚本解释和执行，它可以执行不同类型的操作，包括调用 Python 函数、赋值、输出文本、等待、分支判断等。它还能够解析配置文件和脚本文件，提供运行时的支持，以实现脚本的灵活和可控的执行。

     #### 函数说明：

     1.  `__init__` 方法：初始化 `Interpreter` 类的实例。它接受一个 `configLoader` 参数，用于加载配置信息和初始化其他组件。在构造函数中，它完成了以下任务：
         -   创建一个 `Lexer` 对象和一个 `Parser` 对象，用于分词和解析脚本。
         -   使用传入的 `configLoader` 初始化运行时配置。
         -   加载并解析脚本文件，生成抽象语法树（AST）。
         -   初始化其他属性，如 `runtime`、`job`、`ast` 和 `steps`。
     2.  `accept` 方法：接受一个 `Runtime` 对象作为参数，并开始从 "Main" 步骤运行脚本。这个方法用于执行脚本。
     3.  `run` 方法：开始运行脚本。它首先检查是否设置了运行时和是否已经解析了脚本。然后它从 "Main" 步骤开始执行脚本。
     4.  `stop` 方法：用于停止脚本的执行。它设置一个内部标志 `_stop`，在脚本的执行过程中可以检查这个标志来终止脚本的执行。
     5.  `_getStep` 方法：根据步骤名称获取对应的 AST 节点（步骤定义）。
     6.  `_runStep` 方法：执行一个步骤，包括执行该步骤中的各种表达式。
     7.  `_exec` 方法：执行一个表达式，根据表达式类型执行不同的操作，如调用函数、赋值、输出文本等。
     8.  `_callpy` 方法：调用 Python 函数，并传递参数。它使用 `RunPy` 模块中的 `callFunc` 方法来执行 Python 函数。
     9.  `_exec_switch` 方法：执行 switch 语句，根据条件选择执行不同的分支。
     10.  `_eval` 方法：用于求解一个表达式，返回表达式的值。它可以处理变量、字符串、多个子节点的拼接以及可变参数等情况。
     11.  `_setargs` 方法：将参数传递给运行时，以供后续使用。
     12.  `_load_job` 方法：加载脚本文件，并将其内容存储在 `self.job` 中。
     13.  `_parse` 方法：解析脚本文件，生成抽象语法树（AST）。AST 表示了脚本的结构和逻辑。

3.   ### RunPy

     #### 主要功能：

     管理脚本函数的注册和执行，它可以加载脚本文件、注册脚本函数、调用脚本函数，并根据配置信息决定如何处理脚本执行过程中的异常。

     #### 函数说明：

     1.  `getInstance` 函数：获取全局的 `RunPy` 实例，使用了单例模式，确保在整个应用程序中只有一个 `RunPy` 实例。
     2.  `__init__` 方法：初始化 `RunPy` 类的实例。它初始化了一些属性，如 `_configLoader`（用于加载配置信息）、`_fileList`（用于存储脚本文件的列表）和 `_nameFuncMap`（用于存储脚本函数名称和对应的 Python 函数的映射）。
     3.  `init` 方法：用于初始化全局 `RunPy` 实例。它接受一个 `configLoader` 参数，用于加载配置信息。在初始化过程中，它完成了以下任务：
         -   获取配置中指定的脚本目录列表。
         -   遍历脚本目录列表，获取所有以 `.py` 结尾的脚本文件。
         -   使用 `importlib.util` 模块加载并执行脚本文件，将其导入到运行环境中。
     4.  `register` 方法：为全局 `RunPy` 实例注册脚本函数的装饰器。它接受一个脚本函数的名称作为参数，并返回一个装饰器函数，用于注册脚本函数。注册的脚本函数将存储在 `_nameFuncMap` 中。
     5.  `callFunc` 方法：调用已注册的脚本函数。它接受一个脚本函数的名称和参数列表作为参数。在调用前，它会检查脚本函数是否已注册，以及传入参数的数量是否符合脚本函数的要求。如果脚本函数执行过程中出现异常，根据配置信息决定是否抛出异常或忽略异常。
     6.  `_getConfig` 方法：用于获取配置信息，包括脚本配置中的信息，例如是否启用错误中断（`halt-onerror`）等。
     7.  `_getFiles` 方法：用于获取指定目录下的所有以 `.py` 结尾的脚本文件，并将它们添加到 `_fileList` 列表中。
     8.  `runpy` 对象：全局的 `RunPy` 实例，使用单例模式确保唯一性。

4.   ### Runtime

     #### 主要功能：

     用于管理和执行脚本的运行时环境，包含了一些用于与用户交互、处理变量和执行命令的方法。

     #### 函数说明：

     1.  `__init__` 方法：初始化 `Runtime` 类的实例。它接受三个参数：`number`（用户号码）、`config`（配置加载器对象）和 `enable_timeout`（是否启用超时处理）。在初始化过程中，它完成了以下任务：
         -   存储配置加载器对象和是否启用超时处理的信息。
         -   初始化 `_variables` 字典，用于存储变量的值，包括 `_input`（用户输入的字符串）、`_input_keyword`（从用户输入中提取的关键词）、`_number`（用户号码）和 `_ret`（脚本返回值）。
     2.  `speak` 方法：用于输出文本消息。它将消息以黄色文本打印到控制台，并显示 "Robot >>>" 作为前缀。
     3.  `wait` 方法：等待用户输入，并处理超时情况。它接受一个 `timeStr` 参数，表示等待的时间（秒）。根据是否启用超时处理，它会等待用户输入，如果超过指定时间则超时。用户输入的内容会存储在 `_input` 变量中，并使用 `_extractKeywords` 和 `_extractNumbers` 方法提取关键词和数字。
     4.  `hangup` 方法：用于挂断连接，终止脚本的执行。它会记录用户号码并输出日志信息。
     5.  `assign` 方法：为变量赋值。它接受一个变量名 `var` 和一个值 `val` 作为参数，将值转换为字符串后赋给变量。
     6.  `beep` 方法：用于实现发送滴声的方法，为电话客服设计。它简单地输出 "beep" 到控制台。
     7.  `getvar` 方法：用于获取变量的值。它接受一个变量名 `varname` 作为参数，并返回该变量的值。如果变量不存在，则返回空字符串。
     8.  `_extractKeywords` 方法：从用户输入中提取关键词。它遍历预定义的关键词列表 `KEYWORDS`，如果在用户输入中找到了任何一个关键词，则将该关键词存储在 `_input_keyword` 变量中。
     9.  `_extractNumbers` 方法：从用户输入中提取数字。它使用正则表达式从用户输入中查找数字，并将第一个找到的数字存储在 `_input_number` 变量中。
     10.  `_getConfig` 方法：用于获取配置信息，主要是获取运行时配置。

5.   ### Lexer